<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.sweetk.kcti.survey.mapper.SurveyMapper">

	<insert id="survey_save" parameterType="SurveyVo">
		INSERT INTO survey (survey_target, survey_title, temp_yn, reg_dt, reg_id ,start_dt,end_dt)
		VALUES (#{survey_target}, #{survey_title}, #{temp_yn}, now(), #{reg_id} , #{start_dt}, #{end_dt})
		<selectKey resultType="int" keyProperty="survey_key" order="AFTER">
			select max(survey_key) FROM survey
		</selectKey>
	</insert>

	<insert id="survey_q_save" parameterType="SurveyVo">
		INSERT INTO survey_question (`survey_key`, `question_seq`, `multi_yn`, `question`)
		VALUES (#{survey_key}, #{question_seq} , #{multi_yn} , #{question});
	</insert>

	<insert id="survey_mq_save" parameterType="SurveyVo">
		INSERT INTO multi_question (`survey_key`, `question_seq`, `multi_seq`, `multi_question`)
		VALUES (#{survey_key}, #{question_seq}, #{multi_seq}, #{multi_question});
	</insert>
	
	<select id="surveyList" resultType="SurveyVo">
		SELECT 
			survey_key,
		    survey_target,
		    survey_title,
		    temp_yn,
		    DATE_FORMAT(reg_dt,'%Y-%m-%d') as reg_dt_sv,
		    reg_id,
		    start_dt,
		    end_dt,
		    mod_dt,
		    del_yn,
		    if(now() <![CDATA[ < ]]> end_dt and now() <![CDATA[ > ]]> start_dt ,'진행중','종료') as proc_stat,
		    (select count(*) from answer b where a.survey_key = b.survey_key) as answer_cnt 
		FROM survey a
		WHERE del_yn ='N'
		ORDER BY reg_dt DESC
	</select>
	
	<update id="deleteDelYn" parameterType="SurveyVo">
		UPDATE survey SET del_yn = #{del_yn} WHERE survey_key = #{survey_key}
	</update>
	
	<!-- <delete id="surveyDel" parameterType="SurveyVo">
		DELETE FROM survey WHERE survey_key = #{survey_key};
	</delete> -->
</mapper>